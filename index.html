<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerador de Propostas - Luiz Fosc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, #root { margin: 0; font-family: sans-serif; }
        .g_id_signin { display: inline-block; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google APIs -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <!-- Firebase (for database) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- INÍCIO DA CONFIGURAÇÃO DO FIREBASE (Banco de Dados) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // --- FIM DA CONFIGURAÇÃO DO FIREBASE ---

        // ==================================================================
        // COLE SUAS CREDENCIAIS DO GOOGLE AQUI
        // ==================================================================
        const GOOGLE_API_KEY = 'AIzaSyDW-rF7rJ4Ar-533kuNod24d9x7j0XD_68';
        const GOOGLE_CLIENT_ID = '57826649543-8put6obtsqllqp7vonr04dkt2iifd2op.apps.googleusercontent.com';
        // ==================================================================

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/slides/v1/rest", "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/presentations https://www.googleapis.com/auth/drive.file";
        const TEMPLATE_ID = '1gFZLyOvzyeIZ0cfnwiw4F7hWwC85Rw3PADiOZLSA-zE';
        const ALLOWED_EMAIL = 'luizfosc@gmail.com';

        // --- COMPONENTES DO APLICATIVO ---

        const ProposalForm = ({ userId, onAdd }) => {
            const [formData, setFormData] = useState({
                companyName: '', contactName: '', email: '', phone: '', eventType: '',
                eventDate: '', eventLocation: '', eventAudience: '', price1: '',
                price2: '', price3: '', conversationChannel: '', observations: '',
            });
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => { lucide.createIcons(); }, []);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!userId) return;
                setIsSubmitting(true);
                try {
                    const proposalsCollectionPath = `/artifacts/${appId}/users/${userId}/proposals`;
                    await db.collection(proposalsCollectionPath).add({
                        ...formData,
                        price1: parseFloat(formData.price1) || 0,
                        price2: parseFloat(formData.price2) || 0,
                        price3: parseFloat(formData.price3) || 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    setFormData({
                        companyName: '', contactName: '', email: '', phone: '', eventType: '',
                        eventDate: '', eventLocation: '', eventAudience: '', price1: '',
                        price2: '', price3: '', conversationChannel: '', observations: '',
                    });
                    if(onAdd) onAdd();
                } catch (error) {
                    console.error("Erro ao adicionar proposta: ", error);
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-100">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="plus-circle" className="mr-3 text-blue-500"></i>
                        Criar Nova Proposta (Salvar no Banco de Dados)
                    </h2>
                    <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {[
                            { name: 'companyName', label: 'Nome da Empresa', required: true },
                            { name: 'contactName', label: 'Nome do Contato', required: true },
                            { name: 'email', label: 'Email', type: 'email', required: true },
                            { name: 'phone', label: 'Telefone', type: 'tel' },
                            { name: 'eventType', label: 'Tipo de Evento', required: true },
                            { name: 'eventDate', label: 'Data do Evento', type: 'date', required: true },
                            { name: 'eventLocation', label: 'Local (Cidade-Estado)', required: true },
                            { name: 'eventAudience', label: 'Público do Evento', required: true },
                            { name: 'price1', label: 'Preço 1 (formato 1234.56)', type: 'number', required: true },
                            { name: 'price2', label: 'Preço 2 (formato 1234.56)', type: 'number', required: true },
                            { name: 'price3', label: 'Preço 3 (formato 1234.56)', type: 'number', required: true },
                            { name: 'conversationChannel', label: 'Canal da Conversa', required: true },
                        ].map(field => (
                            <div key={field.name}>
                                <label htmlFor={field.name} className="block text-sm font-medium text-gray-600 mb-1">
                                    {field.label} {field.required && <span className="text-red-500">*</span>}
                                </label>
                                <input
                                    type={field.type || 'text'} id={field.name} name={field.name}
                                    value={formData[field.name]} onChange={handleChange} required={field.required}
                                    className="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    step={field.type === 'number' ? '0.01' : undefined}
                                />
                            </div>
                        ))}
                        <div className="md:col-span-2">
                            <label htmlFor="observations" className="block text-sm font-medium text-gray-600 mb-1">Observações</label>
                            <textarea
                                id="observations" name="observations" value={formData.observations} onChange={handleChange}
                                rows="4" className="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            ></textarea>
                        </div>
                        <div className="md:col-span-2 flex justify-end">
                            <button type="submit" disabled={isSubmitting} className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400">
                                {isSubmitting ? 'Salvando...' : 'Salvar Proposta'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        function App() {
            const [gapiReady, setGapiReady] = useState(false);
            const [gisReady, setGisReady] = useState(false);
            const [user, setUser] = useState(null);
            const [proposals, setProposals] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedUrl, setGeneratedUrl] = useState(null);
            const [loadingError, setLoadingError] = useState(null);

            useEffect(() => {
                if (window.location.protocol === 'file:') {
                    setLoadingError("Este aplicativo não pode ser executado de um arquivo local (file://). Por favor, use um servidor web local para testá-lo.");
                    return;
                }

                const loadTimeout = setTimeout(() => {
                    if (!window.gapi?.client || !window.google?.accounts) {
                        setLoadingError("Falha ao carregar as APIs do Google. Verifique se seu navegador (ex: Brave) ou extensão está bloqueando os scripts. Tente desativar o bloqueador de anúncios para esta página.");
                    }
                }, 10000);

                const apiScript = document.querySelector('script[src="https://apis.google.com/js/api.js"]');
                apiScript.onload = () => {
                    gapi.load('client', async () => {
                        await gapi.client.init({
                            apiKey: GOOGLE_API_KEY,
                            clientId: GOOGLE_CLIENT_ID,
                            discoveryDocs: DISCOVERY_DOCS,
                            scope: SCOPES,
                        }).then(() => setGapiReady(true));
                    });
                };

                const gisScript = document.querySelector('script[src="https://accounts.google.com/gsi/client"]');
                gisScript.onload = () => {
                    clearTimeout(loadTimeout);
                    const tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: SCOPES,
                        callback: async (tokenResponse) => {
                            if (tokenResponse.access_token) {
                                gapi.client.setToken(tokenResponse);
                                const profile = await fetchUserProfile();
                                if (profile) setUser(profile);
                            }
                        },
                    });
                    
                    window.google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: async (response) => {
                            const payload = JSON.parse(atob(response.credential.split('.')[1]));
                            if(payload.email === ALLOWED_EMAIL) {
                                tokenClient.requestAccessToken({ prompt: '' });
                            } else {
                                alert("Acesso negado. Apenas o usuário " + ALLOWED_EMAIL + " pode usar este aplicativo.");
                                handleSignout();
                            }
                        },
                    });
                    setGisReady(true);
                };

                return () => clearTimeout(loadTimeout);
            }, []);

            useEffect(() => {
                if (gisReady && !user) {
                    const buttonDiv = document.getElementById('google-signin-button');
                    if (buttonDiv) {
                      window.google.accounts.id.renderButton(buttonDiv, { theme: 'outline', size: 'large', text: 'signin_with' });
                      window.google.accounts.id.prompt();
                    }
                }
            }, [gisReady, user]);

            useEffect(() => {
                if (!user) return;
                setIsLoading(true);
                const proposalsCollectionPath = `/artifacts/${appId}/users/${user.id}/proposals`;
                const unsubscribe = db.collection(proposalsCollectionPath).orderBy("createdAt", "desc").onSnapshot(snapshot => {
                    setProposals(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                }, err => {
                    console.error("Erro ao buscar propostas:", err);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => { lucide.createIcons(); });

            const fetchUserProfile = async () => {
                try {
                    const response = await gapi.client.request({ 'path': 'https://www.googleapis.com/oauth2/v3/userinfo' });
                    return { id: response.result.sub, email: response.result.email, name: response.result.name };
                } catch (e) { console.error("Erro ao buscar perfil:", e); return null; }
            };
            
            const handleSignout = () => {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken('');
                        setUser(null);
                    });
                }
            };

            const generateProposalOnGoogle = async (proposal) => {
                setIsGenerating(true);
                setGeneratedUrl(null);
                try {
                    const copyTitle = `Proposta para ${proposal.companyName} - Luiz Fosc`;
                    const driveResponse = await gapi.client.drive.files.copy({ fileId: TEMPLATE_ID, resource: { name: copyTitle } });
                    const presentationId = driveResponse.result.id;

                    const requests = [
                        { replaceAllText: { containsText: { text: '{{NOME_EMPRESA}}' }, replaceText: proposal.companyName } },
                        { replaceAllText: { containsText: { text: '{{NOME_CONTATO}}' }, replaceText: proposal.contactName } },
                        { replaceAllText: { containsText: { text: '{{CANAL_CONVERSA}}' }, replaceText: proposal.conversationChannel } },
                        { replaceAllText: { containsText: { text: '{{TIPO_EVENTO}}' }, replaceText: proposal.eventType } },
                        { replaceAllText: { containsText: { text: '{{DATA_EVENTO}}' }, replaceText: new Date(proposal.eventDate).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric', timeZone: 'UTC' }) } },
                        { replaceAllText: { containsText: { text: '{{LOCAL_EVENTO}}' }, replaceText: proposal.eventLocation } },
                        { replaceAllText: { containsText: { text: '{{PUBLICO_EVENTO}}' }, replaceText: proposal.eventAudience } },
                        { replaceAllText: { containsText: { text: '{{PRECO_1}}' }, replaceText: (proposal.price1 || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) } },
                        { replaceAllText: { containsText: { text: '{{PRECO_2}}' }, replaceText: (proposal.price2 || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) } },
                        { replaceAllText: { containsText: { text: '{{PRECO_3}}' }, replaceText: (proposal.price3 || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) } },
                        { replaceAllText: { containsText: { text: '{{OBSERVACOES}}' }, replaceText: proposal.observations || 'Nenhuma observação adicional.' } },
                    ];

                    await gapi.client.slides.presentations.batchUpdate({ presentationId, resource: { requests } });
                    setGeneratedUrl(`https://docs.google.com/presentation/d/${presentationId}/edit`);
                } catch (err) {
                    console.error("Erro ao gerar proposta:", err);
                    alert("Ocorreu um erro. Verifique o console para detalhes.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleDelete = async (id) => {
                if (confirm("Tem certeza que deseja excluir esta proposta?")) {
                    const docPath = `/artifacts/${appId}/users/${user.id}/proposals/${id}`;
                    await db.doc(docPath).delete();
                }
            };

            if (loadingError) {
                return (
                    <div className="flex items-center justify-center h-screen bg-red-50 text-red-800 p-8">
                        <div className="text-center">
                            <i data-lucide="alert-triangle" className="w-16 h-16 mx-auto mb-4"></i>
                            <h2 className="text-2xl font-bold mb-2">Erro de Configuração</h2>
                            <p className="max-w-xl">{loadingError}</p>
                        </div>
                    </div>
                );
            }

            if (!gapiReady || !gisReady) {
                return <div className="flex items-center justify-center h-screen">Carregando APIs do Google...</div>;
            }

            if (!user) {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-gray-100">
                        <h1 className="text-2xl font-bold mb-4">Gerador de Propostas</h1>
                        <p className="mb-6">Por favor, faça login com sua conta Google para continuar.</p>
                        <div id="google-signin-button"></div>
                    </div>
                );
            }

            return (
                <div className="bg-gray-50 min-h-screen font-sans text-gray-900">
                    <header className="bg-white shadow-sm">
                        <div className="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">Gerador de Propostas</h1>
                            <div>
                                <span className="text-sm mr-4">Logado como: {user.name}</span>
                                <button onClick={handleSignout} className="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-sm hover:bg-red-600">Sair</button>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                        <ProposalForm userId={user.id} />

                        <div className="mt-12">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">Propostas Salvas</h2>
                            {isLoading ? <p>Carregando propostas...</p> : (
                                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                                    {proposals.length === 0 && <p className="p-6 text-gray-500">Nenhuma proposta salva ainda.</p>}
                                    {proposals.map(p => (
                                        <div key={p.id} className="p-4 flex flex-col md:flex-row justify-between items-start md:items-center border-b last:border-b-0">
                                            <div className="mb-4 md:mb-0">
                                                <p className="font-bold text-lg">{p.companyName}</p>
                                                <p className="text-sm text-gray-600">{p.contactName} - {new Date(p.eventDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p>
                                            </div>
                                            <div className="flex space-x-2 w-full md:w-auto">
                                                <button onClick={() => generateProposalOnGoogle(p)} disabled={isGenerating} className="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg disabled:bg-gray-400 flex items-center justify-center">
                                                    <i data-lucide="file-up" className="w-4 h-4 mr-2"></i>
                                                    {isGenerating ? 'Gerando...' : 'Gerar'}
                                                </button>
                                                <button onClick={() => handleDelete(p.id)} className="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg flex items-center justify-center">
                                                    <i data-lucide="trash-2" className="w-4 h-4 mr-2"></i>
                                                    Excluir
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        {generatedUrl && (
                            <div className="mt-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                                Proposta gerada com sucesso! <a href={generatedUrl} target="_blank" rel="noopener noreferrer" className="font-bold underline">Clique aqui para abrir.</a>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
