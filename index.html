<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerador de Propostas - Luiz Fosc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, #root { margin: 0; font-family: sans-serif; }
        @media print {
            body * { visibility: hidden; }
            .print-container, .print-container * { visibility: visible; }
            .print-container { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase (for database) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- NOVO: Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- INÍCIO DA CONFIGURAÇÃO DO FIREBASE (Banco de Dados) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // --- FIM DA CONFIGURAÇÃO DO FIREBASE ---

        // --- COMPONENTES DO APLICATIVO ---

        const ProposalForm = ({ userId, onAdd }) => {
            const [formData, setFormData] = useState({
                companyName: '', contactName: '', email: '', phone: '', eventType: '',
                eventDate: '', eventLocation: '', eventAudience: '', price1: '',
                price2: '', price3: '', conversationChannel: '', observations: '',
            });
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => { lucide.createIcons(); }, []);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!userId) return;
                setIsSubmitting(true);
                try {
                    const proposalsCollectionPath = `/artifacts/${appId}/users/${userId}/proposals`;
                    await db.collection(proposalsCollectionPath).add({
                        ...formData,
                        price1: parseFloat(formData.price1) || 0,
                        price2: parseFloat(formData.price2) || 0,
                        price3: parseFloat(formData.price3) || 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    setFormData({
                        companyName: '', contactName: '', email: '', phone: '', eventType: '',
                        eventDate: '', eventLocation: '', eventAudience: '', price1: '',
                        price2: '', price3: '', conversationChannel: '', observations: '',
                    });
                    if(onAdd) onAdd();
                } catch (error) {
                    console.error("Erro ao adicionar proposta: ", error);
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-100">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="plus-circle" className="mr-3 text-blue-500"></i>
                        Criar Nova Proposta
                    </h2>
                    <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {[
                            { name: 'companyName', label: 'Nome da Empresa', required: true },
                            { name: 'contactName', label: 'Nome do Contato', required: true },
                            { name: 'email', label: 'Email', type: 'email', required: true },
                            { name: 'phone', label: 'Telefone', type: 'tel' },
                            { name: 'eventType', label: 'Tipo de Evento', required: true },
                            { name: 'eventDate', label: 'Data do Evento', type: 'date', required: true },
                            { name: 'eventLocation', label: 'Local (Cidade-Estado)', required: true },
                            { name: 'eventAudience', label: 'Público do Evento', required: true },
                            { name: 'price1', label: 'Preço 1 (formato 1234.56)', type: 'number', required: true },
                            { name: 'price2', label: 'Preço 2 (formato 1234.56)', type: 'number', required: true },
                            { name: 'price3', label: 'Preço 3 (formato 1234.56)', type: 'number', required: true },
                            { name: 'conversationChannel', label: 'Canal da Conversa', required: true },
                        ].map(field => (
                            <div key={field.name}>
                                <label htmlFor={field.name} className="block text-sm font-medium text-gray-600 mb-1">
                                    {field.label} {field.required && <span className="text-red-500">*</span>}
                                </label>
                                <input
                                    type={field.type || 'text'} id={field.name} name={field.name}
                                    value={formData[field.name]} onChange={handleChange} required={field.required}
                                    className="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    step={field.type === 'number' ? '0.01' : undefined}
                                />
                            </div>
                        ))}
                        <div className="md:col-span-2">
                            <label htmlFor="observations" className="block text-sm font-medium text-gray-600 mb-1">Observações</label>
                            <textarea
                                id="observations" name="observations" value={formData.observations} onChange={handleChange}
                                rows="4" className="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            ></textarea>
                        </div>
                        <div className="md:col-span-2 flex justify-end">
                            <button type="submit" disabled={isSubmitting} className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400">
                                {isSubmitting ? 'Salvando...' : 'Salvar Proposta'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        const ProposalPreviewModal = ({ proposal, onClose }) => {
            if (!proposal) return null;
            
            const formatCurrency = (value) => (parseFloat(value) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatDate = (value) => new Date(value).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric', timeZone: 'UTC' });

            // NOVO: Função para baixar o PDF
            const handleDownloadPDF = () => {
                const element = document.getElementById('proposal-content');
                const opt = {
                  margin:       0,
                  filename:     `Proposta - ${proposal.companyName}.pdf`,
                  image:        { type: 'jpeg', quality: 0.98 },
                  html2canvas:  { scale: 2 },
                  jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().from(element).set(opt).save();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex flex-col justify-center items-center z-50 p-4 no-print">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-800">Visualização da Proposta</h3>
                            <div>
                                {/* BOTÃO ATUALIZADO */}
                                <button onClick={handleDownloadPDF} className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 mr-2">
                                    Baixar como PDF
                                </button>
                                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" className="text-gray-600"></i></button>
                            </div>
                        </div>
                        {/* ID adicionado para a biblioteca de PDF encontrar este conteúdo */}
                        <div id="proposal-content" className="overflow-y-auto p-8 md:p-12 text-gray-800">
                             <h1 className="text-3xl font-bold text-center mb-2">Proposta de Palestra e Workshop</h1>
                            <h2 className="text-xl text-center text-gray-600 mb-10">Para: {proposal.companyName}</h2>

                            <p className="mb-6">Prezado(a) <strong>{proposal.contactName}</strong>,</p>
                            <p className="mb-6">Conforme nossa conversa via <strong>{proposal.conversationChannel}</strong>, é com grande prazer que apresento esta proposta para a realização de uma palestra/workshop em seu evento.</p>

                            <div className="bg-gray-50 p-6 rounded-lg border my-8">
                                <h3 className="text-xl font-semibold mb-4 border-b pb-2">Detalhes do Evento</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <p><strong>Tipo:</strong> {proposal.eventType}</p>
                                    <p><strong>Data:</strong> {formatDate(proposal.eventDate)}</p>
                                    <p><strong>Local:</strong> {proposal.eventLocation}</p>
                                    <p><strong>Público:</strong> {proposal.eventAudience}</p>
                                </div>
                            </div>

                            <h3 className="text-xl font-semibold mt-8 mb-4">Opções de Investimento</h3>
                            <div className="space-y-4">
                                <div className="border p-4 rounded-lg flex justify-between items-center"><span className="font-medium">Opção 1</span><span className="font-bold text-lg text-green-600">{formatCurrency(proposal.price1)}</span></div>
                                <div className="border p-4 rounded-lg flex justify-between items-center"><span className="font-medium">Opção 2</span><span className="font-bold text-lg text-green-600">{formatCurrency(proposal.price2)}</span></div>
                                <div className="border p-4 rounded-lg flex justify-between items-center"><span className="font-medium">Opção 3</span><span className="font-bold text-lg text-green-600">{formatCurrency(proposal.price3)}</span></div>
                            </div>

                            {proposal.observations && (
                                <>
                                    <h3 className="text-xl font-semibold mt-8 mb-4">Observações Adicionais</h3>
                                    <p className="p-4 border bg-yellow-50 rounded-lg whitespace-pre-wrap">{proposal.observations}</p>
                                </>
                            )}

                            <div className="mt-12 text-center text-sm text-gray-500">
                                <p>Agradeço a oportunidade e fico à disposição para quaisquer esclarecimentos.</p>
                                <p className="mt-4 font-semibold">Luiz Fosc</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [userId, setUserId] = useState(null);
            const [proposals, setProposals] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedProposal, setSelectedProposal] = useState(null);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        auth.signInAnonymously().catch(error => {
                            console.error("Erro no login anônimo:", error);
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!userId) return;
                setIsLoading(true);
                const proposalsCollectionPath = `/artifacts/${appId}/users/${userId}/proposals`;
                const unsubscribe = db.collection(proposalsCollectionPath).orderBy("createdAt", "desc").onSnapshot(snapshot => {
                    setProposals(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                }, err => {
                    console.error("Erro ao buscar propostas:", err);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [userId]);

            useEffect(() => { lucide.createIcons(); });

            const handleDelete = async (id) => {
                if (confirm("Tem certeza que deseja excluir esta proposta?")) {
                    const docPath = `/artifacts/${appId}/users/${userId}/proposals/${id}`;
                    await db.doc(docPath).delete();
                }
            };

            return (
                <div className="bg-gray-100 min-h-screen">
                    <header className="bg-white shadow-sm">
                        <div className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                            <h1 className="text-3xl font-bold text-gray-900">Gerador de Propostas - Luiz Fosc</h1>
                        </div>
                    </header>
                    <main className="max-w-4xl mx-auto py-8 px-4">
                        <ProposalForm userId={userId} />
                        <div className="mt-12">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">Propostas Salvas</h2>
                            {isLoading ? <p>Carregando...</p> : (
                                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                                    {proposals.length === 0 && <p className="p-6 text-gray-500">Nenhuma proposta salva ainda.</p>}
                                    {proposals.map(p => (
                                        <div key={p.id} className="p-4 flex flex-col md:flex-row justify-between items-start md:items-center border-b last:border-b-0">
                                            <div className="mb-4 md:mb-0">
                                                <p className="font-bold text-lg">{p.companyName}</p>
                                                <p className="text-sm text-gray-600">{p.contactName} - {new Date(p.eventDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p>
                                            </div>
                                            <div className="flex space-x-2 w-full md:w-auto">
                                                <button onClick={() => setSelectedProposal(p)} className="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg flex items-center justify-center">
                                                    <i data-lucide="file-check" className="w-4 h-4 mr-2"></i>
                                                    Gerar
                                                </button>
                                                <button onClick={() => handleDelete(p.id)} className="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg flex items-center justify-center">
                                                    <i data-lucide="trash-2" className="w-4 h-4 mr-2"></i>
                                                    Excluir
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                    {selectedProposal && <ProposalPreviewModal proposal={selectedProposal} onClose={() => setSelectedProposal(null)} />}
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
